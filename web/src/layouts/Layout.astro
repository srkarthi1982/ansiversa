---
import { Dropdown, Button, Breadcrumb, Loader } from '@ansiversa/components';
import '../styles/global.css';
import '@fortawesome/fontawesome-free/css/all.min.css';
import { actions } from 'astro:actions';
import { ClientRouter } from 'astro:transitions';
import { getSessionWithUser } from '../utils/session.server';
const sessionData = await getSessionWithUser(Astro.cookies);
const isLoggedIn = Boolean(sessionData);
const userInitial = sessionData?.user?.username?.charAt(0)?.toUpperCase() ?? 'U';
const logoutAction = actions.auth.logout;
const username = (sessionData?.user?.username ?? 'Account').toUpperCase();
const shouldShowBreadcrumb = Astro.url.pathname !== '/';
const primaryNavLinks = [
  { label: 'Features', href: '/app/features' },
  { label: 'Pricing', href: '/app/pricing' },
  { label: 'Docs', href: '/app/documentation' },
  { label: 'FAQ', href: '/app/faq' },
  { label: 'Contact', href: '/app/contact' },
];
const navbarActions = [
  { label: 'Docs', href: '/app/documentation', variant: 'ghost' },
  ...(isLoggedIn ? [] : [{ label: 'Log in', href: '/app/login', variant: 'outline' }]),
];
const navbarUserMenu = isLoggedIn
  ? {
      name: username,
      initial: userInitial,
      items: [
        { label: 'Dashboard', href: '/app/dashboard' },
        { label: 'Settings', href: '/app/settings' },
        { label: 'Billing', href: '/app/billing' },
        { label: 'Change password', href: '/app/change-password' },
      ],
      logout: { action: logoutAction, method: 'POST', label: 'Log out' },
  }
  : null;
const isAdmin = sessionData?.user?.roleId === 1;
const navbarVariant = 'light';
const isDarkNavbar = navbarVariant === 'dark';
const baseBg = isDarkNavbar ? 'bg-slate-900/80 text-white' : 'bg-white/80 text-slate-900';
const borderColor = isDarkNavbar ? 'border-slate-700/60' : 'border-slate-200';
const actionBaseClass =
  'inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-semibold transition focus:outline-none focus:ring-2 focus:ring-offset-2';
const outlineClass = isDarkNavbar
  ? 'border-white/30 text-white hover:bg-white/10 focus:ring-indigo-300 focus:ring-offset-slate-900'
  : 'border text-indigo-600 hover:bg-indigo-50 focus:ring-indigo-200 focus:ring-offset-white';
const solidClass = isDarkNavbar
  ? 'border-transparent bg-indigo-500 text-white hover:bg-indigo-400 focus:ring-indigo-300 focus:ring-offset-slate-900'
  : 'border-transparent bg-indigo-600 text-white hover:bg-indigo-500 focus:ring-indigo-200 focus:ring-offset-white';
const ghostClass = isDarkNavbar
  ? 'border-transparent text-white hover:text-indigo-300 focus:ring-indigo-300 focus:ring-offset-slate-900'
  : 'border-transparent text-slate-900 hover:text-indigo-600 focus:ring-indigo-200 focus:ring-offset-white';
const getActionClass = (variant = 'outline') => {
  if (variant === 'solid') return `${actionBaseClass} ${solidClass}`;
  if (variant === 'ghost') return `${actionBaseClass} ${ghostClass}`;
  return `${actionBaseClass} ${outlineClass}`;
};
interface UserMenu {
  initial?: string;
  name?: string;
}

const getInitial = (menu: UserMenu | null) => menu?.initial?.charAt(0)?.toUpperCase() ?? menu?.name?.charAt(0)?.toUpperCase() ?? 'U';
const resolvedLinks = primaryNavLinks;
const resolvedActions = navbarActions;
const resolvedMobileLinks = resolvedLinks;
const resolvedMobileActions = resolvedActions;
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="generator" content={Astro.generator} />
		<title>Ansiversa — Advanced Next‑Gen Software Innovation</title>
		<meta name="description" content="Ansiversa builds versatile, next‑gen software products and platforms." />
		<ClientRouter />
		<link rel="icon" href="/favicon/favicon.ico" />
    <script>import '../alpineStores/index.ts';</script>
    <script type="module" is:inline>
      const isStoreExists = name => typeof Alpine?.store(name) !== 'undefined';
      const resolveStoreName = (pathname) => {
        const segments = pathname.split('/').filter(Boolean);
        if (segments.includes('resume-builder')) {
          return 'resume';
        }
        return segments.at(-1) ?? '';
      };
      function onPreparation(location) {
        if(location.pathname === '/'){
          const homeStore = Alpine.store('home');
          if (homeStore && typeof homeStore.onInit === 'function') {
            homeStore.onInit();
          }
          return;
        }
        const name = resolveStoreName(location.pathname);
        if(isStoreExists(name)) {
          const store = Alpine.store(name);
          if (store && typeof store.onInit === 'function') {
            store.onInit(location);
          }
        }
      }

      document.addEventListener('astro:before-preparation', (event) => onPreparation(event.to));
      document.addEventListener('DOMContentLoaded', () => onPreparation(window.location));
    </script>
	</head>
	<body class="antialiased bg-white text-slate-900">
    <div id="loading" class="fixed top-0 left-0 w-full h-0.5 bg-primary-600 scale-x-1 origin-left transition-transform duration-400 ease-out z-50"></div>
		<!-- NAVBAR -->
    <header x-data="{ open:false }" class={`sticky top-0 z-40 border-b backdrop-blur ${baseBg} ${borderColor}`}>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <a href="/" class="flex flex-col leading-tight transition-colors">
            <span class="text-xl md:text-2xl font-semibold tracking-wide">ANSIVERSA</span>
            <span class="text-[0.625rem] uppercase opacity-70">Curated App Suite</span>
          </a>
          <nav class="hidden md:flex items-center gap-8 text-sm">
            {resolvedLinks.map((link) => (
              <a href={link.href} class={isDarkNavbar ? 'hover:text-indigo-300' : 'hover:text-indigo-600'}>
                {link.label}
              </a>
            ))}
          </nav>
          <div class="hidden md:flex items-center gap-3">
            {resolvedActions.map((action) => (
              <a
                href={action.href}
                target={action.external ? '_blank' : undefined}
                rel={action.external ? 'noreferrer' : undefined}
                class={getActionClass(action.variant)}
              >
                {action.label}
              </a>
            ))}
            {navbarUserMenu && (
              <Dropdown
                align="right"
                triggerClass="flex h-10 w-10 items-center justify-center rounded-full bg-indigo-600 text-sm font-semibold text-white hover:bg-indigo-500"
                triggerAriaLabel="User menu"
              >
                <span slot="trigger">{getInitial(navbarUserMenu)}</span>
                <div class="border-b border-slate-200 px-4 py-2">
                  <p class="text-sm font-semibold text-slate-900">{navbarUserMenu.name}</p>
                </div>
                {navbarUserMenu.items.map((item) => (
                  <a href={item.href} class="block px-4 py-2 text-slate-700 hover:bg-slate-100">
                    {item.label}
                  </a>
                ))}
                {navbarUserMenu.logout &&
                  (navbarUserMenu.logout.method === 'GET' ? (
                    <a href={navbarUserMenu.logout.action} class="block px-4 py-2 text-left text-red-600 hover:bg-slate-100">
                      {navbarUserMenu.logout.label ?? 'Log out'}
                    </a>
                  ) : (
                    <form method="POST" action={navbarUserMenu.logout.action}>
                      <button
                        type="submit"
                        class="flex w-full items-center gap-2 px-4 py-2 text-left text-red-600 hover:bg-slate-100"
                      >
                        {navbarUserMenu.logout.label ?? 'Log out'}
                      </button>
                    </form>
                  ))}
              </Dropdown>
            )}
          </div>
          <button
            x-on:click="open = !open"
            class={`md:hidden inline-flex items-center justify-center rounded-lg border p-2 ${borderColor}`}
            aria-label="Toggle navigation menu"
          >
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
        <div x-show="open" x-transition.duration.200ms x-cloak class="md:hidden pb-4">
          <div class="flex flex-col gap-2 text-sm">
            {resolvedMobileLinks.map((link) => (
              <a x-on:click="open=false" href={link.href} class="px-3 py-2 rounded-lg hover:bg-indigo-50/20">
                {link.label}
              </a>
            ))}
            {navbarUserMenu && (
              <div class="mt-4 rounded-xl border px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-600 text-xs font-bold text-white">
                    {getInitial(navbarUserMenu)}
                  </span>
                  <div>
                    <p class="text-sm font-semibold text-slate-900">{navbarUserMenu.name}</p>
                    <p class="text-xs text-slate-500">Account</p>
                  </div>
                </div>
                <div class="mt-3 flex flex-col">
                  {navbarUserMenu.items.map((item) => (
                    <a href={item.href} class="px-2 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">
                      {item.label}
                    </a>
                  ))}
                  {navbarUserMenu.logout &&
                    (navbarUserMenu.logout.method === 'GET' ? (
                      <a
                        href={navbarUserMenu.logout.action}
                        class="px-2 py-2 text-sm font-semibold text-red-600 hover:bg-slate-100 rounded-md"
                      >
                        {navbarUserMenu.logout.label ?? 'Log out'}
                      </a>
                    ) : (
                      <form method="POST" action={navbarUserMenu.logout.action}>
                        <button
                          type="submit"
                          class="w-full px-2 py-2 text-left text-sm font-semibold text-red-600 hover:bg-slate-100 rounded-md"
                        >
                          {navbarUserMenu.logout.label ?? 'Log out'}
                        </button>
                      </form>
                    ))}
                </div>
              </div>
            )}
            {resolvedMobileActions.length > 0 && (
              <div class="mt-3 flex flex-col gap-2">
                {resolvedMobileActions.map((action) => (
                  <a
                    href={action.href}
                    target={action.external ? '_blank' : undefined}
                    rel={action.external ? 'noreferrer' : undefined}
                    class={`${getActionClass(action.variant)} w-full text-center`}
                  >
                    {action.label}
                  </a>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  <main transition:name="page">
    {shouldShowBreadcrumb && <Breadcrumb />}
    <slot />
  </main>

		<!-- CTA -->
  <section id="cta" class="py-14">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="rounded-2xl border bg-gradient-to-tr from-indigo-700 via-indigo-600 to-indigo-500 p-8 text-white">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <div>
            <h3 class="text-2xl font-bold">Ready to explore Ansiversa?</h3>
            <p class="mt-1 text-sm text-white/90">
              {isLoggedIn
                ? "Thanks for being part of the Ansiversa workspace—dive into your mini-apps below."
                : "Create an account to unlock curated mini-apps crafted by the Ansiversa team."}
            </p>
          </div>
          <div class="flex gap-3">
            {!isLoggedIn && (
              <Button href="/app/signup" variant="light" size="lg">
                Get started
              </Button>
            )}
            <Button href="/#mini-apps" variant="secondary" size="lg">
              Discover mini-apps
            </Button>
          </div>
        </div>
      </div>
    </div>
  </section>
  		<Loader />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}
</style>
