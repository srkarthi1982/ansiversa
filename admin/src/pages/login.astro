---
import Layout from '../layouts/Layout.astro';

export const prerender = false;

const requestedRedirect = Astro.url.searchParams.get('redirect') ?? '/';
const coreApiBaseUrl = import.meta.env.PUBLIC_CORE_API_BASE_URL ?? 'http://localhost:2000';
---
<Layout>
  <section class="mx-auto max-w-md px-4 py-16">
    <div class="mb-8 text-center">
      <p class="text-xs font-semibold uppercase tracking-[0.4em] text-slate-500">Administrator</p>
      <h1 class="mt-3 text-3xl font-bold text-slate-900">Ansiversa Admin Portal</h1>
      <p class="mt-2 text-sm text-slate-600">Sign in with your admin workspace credentials.</p>
    </div>

    <div class="rounded-3xl border border-slate-200/80 bg-white/70 p-8 shadow-soft">
      <div id="login-error" class="mb-4 hidden rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>

      <form id="login-form" class="space-y-4">
        <input type="hidden" name="redirect" value={requestedRedirect} />

        <label class="block text-sm font-semibold text-slate-800">
          Username or email
          <input
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-slate-900 placeholder:text-slate-400 focus:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-300"
            type="text"
            name="identifier"
            placeholder="admin@ansiversa.com"
            autocomplete="username"
            required
          />
        </label>

        <label class="block text-sm font-semibold text-slate-800">
          Password
          <input
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-slate-900 placeholder:text-slate-400 focus:border-indigo-400 focus:outline-none focus:ring-1 focus:ring-indigo-300"
            type="password"
            name="password"
            placeholder="••••••••"
            autocomplete="current-password"
            minlength={6}
            required
          />
        </label>

        <div class="flex items-center justify-between text-sm">
          <label class="inline-flex items-center gap-2 text-slate-700">
            <input
              type="checkbox"
              name="remember"
              value="on"
              class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
            />
            Remember me
          </label>
          <span class="text-slate-400">Need access? Contact Ops.</span>
        </div>

        <button
          type="submit"
          class="inline-flex w-full items-center justify-center rounded-2xl bg-slate-900 px-5 py-2.5 text-sm font-semibold tracking-wide text-white transition hover:-translate-y-0.5 hover:bg-slate-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
        >
          <span id="login-button-label">Sign in</span>
          <svg id="login-spinner" class="ml-2 hidden h-4 w-4 animate-spin text-white" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
        </button>

        <p id="login-status" class="text-center text-sm text-slate-600"></p>
      </form>
    </div>

    <p class="mt-10 text-center text-sm text-slate-500">
      Looking for the public experience? <a href="https://www.ansiversa.com" class="font-semibold text-indigo-600 hover:underline">Visit ansiversa.com</a>
    </p>
  </section>
</Layout>

<script is:inline type="module">
  const API_BASE = 'http://localhost:2000'; // Adjust as needed or use environment variables
  const form = document.getElementById('login-form');
  const errorBox = document.getElementById('login-error');
  const statusEl = document.getElementById('login-status');
  const button = form?.querySelector('button[type="submit"]');
  const spinner = document.getElementById('login-spinner');
  const buttonLabel = document.getElementById('login-button-label');

  const setLoading = (state) => {
    if (!button || !spinner || !buttonLabel) return;
    button.disabled = state;
    spinner.classList.toggle('hidden', !state);
    buttonLabel.textContent = state ? 'Signing in…' : 'Sign in';
  };

  const showError = (message) => {
    if (!errorBox) return;
    if (!message) {
      errorBox.classList.add('hidden');
      errorBox.textContent = '';
      return;
    }
    errorBox.textContent = message;
    errorBox.classList.remove('hidden');
  };

  const setStatus = (message) => {
    if (statusEl) statusEl.textContent = message ?? '';
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    showError('');
    setStatus('');
    setLoading(true);

    const formData = new FormData(form);
    const payload = {
      identifier: String(formData.get('identifier') ?? '').trim(),
      password: String(formData.get('password') ?? ''),
      remember: formData.get('remember') === 'on',
    };

    try {
      const response = await fetch(`${API_BASE}/api/auth/login`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'include',
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        const message = data?.error ?? 'Login failed. Please try again.';
        throw new Error(message);
      }

      if (data?.accessToken) {
        localStorage.setItem('ansiversa_access_token', data.accessToken);
      }

      setStatus('Success! Redirecting…');
      const redirect = String(formData.get('redirect') ?? '/') || '/';
      window.location.href = redirect;
    } catch (error) {
      console.error('[admin/login] failed', error);
      showError(error instanceof Error ? error.message : 'Unable to sign in');
    } finally {
      setLoading(false);
    }
  });
</script>
