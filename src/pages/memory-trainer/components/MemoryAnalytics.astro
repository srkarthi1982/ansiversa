---
import Button from '../../../components/Button.astro';
import SectionHeading from '../../../components/SectionHeading.astro';
---
<section class="relative pb-20">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="grid gap-10 lg:grid-cols-[1.05fr_0.95fr]">
      <div class="space-y-6">
        <SectionHeading
          eyebrow="Insights"
          title="Progress analytics and forgetting curves"
          description="Track rolling accuracy, latency bands, and predicted retention to spot plateaus before they stick."
        />
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Accuracy trend</h3>
          <div class="mt-4 space-y-3">
            <template x-for="point in app.state.analytics.accuracyTrend" :key="point.label">
              <div>
                <div class="flex items-center justify-between text-xs font-semibold text-slate-500">
                  <span x-text="point.label"></span>
                  <span x-text="`${point.value}%`"></span>
                </div>
                <div class="mt-1 h-2 rounded-full bg-slate-100">
                  <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 via-sky-500 to-emerald-500" :style="`width: ${point.value}%`"></div>
                </div>
              </div>
            </template>
          </div>
        </div>
        <div class="grid gap-6 sm:grid-cols-2">
          <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Reaction time bands</h3>
            <div class="mt-4 space-y-3">
              <template x-for="band in app.state.analytics.reactionTimes" :key="band.label">
                <div class="flex items-center gap-3">
                  <span class="w-24 text-xs font-semibold text-slate-500" x-text="band.label"></span>
                  <div class="flex-1">
                    <div class="h-2 rounded-full bg-slate-100">
                      <div
                        class="h-full rounded-full bg-indigo-400"
                        :style="`width: ${Math.min(100, Math.round((band.milliseconds / 2100) * 100))}%`
                      ></div>
                    </div>
                    <p class="mt-1 text-xs text-slate-500" x-text="`${band.milliseconds} ms`"></p>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Forgetting curve</h3>
            <div class="mt-4 space-y-3">
              <template x-for="point in app.state.analytics.forgettingCurve" :key="point.day">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-slate-900">Day <span x-text="point.day"></span></p>
                    <p class="text-xs text-slate-500">Retention prediction</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-lg font-bold text-indigo-600" x-text="`${point.retention}%`"></span>
                    <div class="h-2 w-20 rounded-full bg-slate-100">
                      <div class="h-full rounded-full bg-emerald-400" :style="`width: ${point.retention}%`"></div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
      <div class="space-y-6">
        <SectionHeading
          eyebrow="Deck console"
          title="Spaced repetition and exports"
          description="Rotate decks, grade cards with SM-2 logic, and pull quick exports for coaches or peers."
        />
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-start justify-between gap-4">
            <div>
              <p class="text-sm font-semibold text-slate-900">Decks due today</p>
              <p class="text-xs text-slate-500">Switch decks to refresh the queue with context-aware prompts.</p>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-700">
              <i class="fas fa-layer-group text-[10px]"></i>
              <span x-text="app.state.decks.length"></span> decks
            </span>
          </header>
          <div class="mt-5 grid gap-3">
            <template x-for="deck in app.state.decks" :key="deck.id">
              <button
                type="button"
                class="flex items-center justify-between gap-3 rounded-2xl border px-4 py-3 text-left transition"
                :class="deck.id === app.state.srs.activeDeckId
                  ? 'border-indigo-400 bg-indigo-50 text-indigo-700 shadow-sm'
                  : 'border-slate-200 bg-slate-50 text-slate-600'"
                @click.prevent="app.switchDeck(deck.id)"
              >
                <div>
                  <p class="text-sm font-semibold" x-text="deck.name"></p>
                  <p class="text-xs" x-text="`${deck.dueToday} due • ${deck.newCount} new • streak ${deck.streak}`"></p>
                </div>
                <div class="text-right text-xs">
                  <p class="font-semibold" x-text="deck.tag"></p>
                  <p class="text-slate-500">Next <span x-text="new Date(deck.nextDue).toLocaleDateString()"></span></p>
                </div>
              </button>
            </template>
          </div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Active review queue</h3>
          <template x-if="app.state.srs.queue.length">
            <div class="mt-4 space-y-5">
              <article class="rounded-2xl border border-slate-100 bg-slate-50/70 p-5">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Prompt</p>
                <p class="mt-2 text-base font-semibold text-slate-900" x-text="app.state.srs.queue[0].front"></p>
                <p class="mt-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Answer</p>
                <p class="mt-1 text-sm text-slate-600" x-text="app.state.srs.queue[0].back"></p>
                <p class="mt-4 text-xs text-slate-500">
                  <i class="fas fa-chart-line mr-2 text-[10px] text-indigo-500"></i>
                  Ease <span x-text="app.state.srs.queue[0].easeFactor"></span> · Interval <span x-text="app.state.srs.queue[0].intervalDays"></span>d · Lapses <span x-text="app.state.srs.queue[0].lapses"></span>
                </p>
              </article>
              <div class="flex flex-wrap gap-2">
                <template x-for="grade in [1,2,3,4,5]" :key="grade">
                  <Button
                    type="button"
                    size="sm"
                    variant="light"
                    class="border border-slate-200"
                    @click.prevent="app.gradeCard(grade)"
                  >
                    <span class="text-xs font-semibold" x-text="grade"></span>
                  </Button>
                </template>
              </div>
            </div>
          </template>
          <template x-if="!app.state.srs.queue.length">
            <div class="mt-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 p-6 text-center text-xs text-slate-500">
              All due cards cleared. Import from FlashNote to keep the streak alive.
            </div>
          </template>
          <div class="mt-5 space-y-3" x-show="app.state.srs.completed.length" x-cloak>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Recent grads</p>
            <template x-for="card in app.state.srs.completed" :key="card.id">
              <div class="flex items-center justify-between rounded-2xl border border-slate-100 bg-white px-3 py-2 text-xs text-slate-500">
                <span class="font-semibold text-slate-600" x-text="card.front"></span>
                <span>
                  Interval <strong x-text="card.intervalDays"></strong>d · Ease <strong x-text="card.easeFactor"></strong>
                </span>
              </div>
            </template>
          </div>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-indigo-500">Exports</h3>
          <div class="mt-4 space-y-3 text-sm text-slate-600">
            <template x-for="entry in app.state.exports" :key="entry.id">
              <div class="flex items-center justify-between gap-3 rounded-2xl border border-slate-100 bg-slate-50/70 px-4 py-3">
                <div>
                  <p class="font-semibold text-slate-900">
                    <i class="fas fa-file-export mr-2 text-indigo-500"></i>
                    <span x-text="entry.format.toUpperCase()"></span>
                  </p>
                  <p class="text-xs text-slate-500" x-text="new Date(entry.createdAt).toLocaleString()"></p>
                </div>
                <div class="text-right text-xs">
                  <p><span x-text="entry.sizeKb"></span> KB</p>
                  <p class="text-slate-500">
                    <i class="fas" :class="entry.includeWatermark ? 'fa-water' : 'fa-circle-check'"></i>
                    <span x-text="entry.includeWatermark ? 'Watermarked' : 'Clean'"></span>
                  </p>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
