---
import Modal from "../../../components/Modal.astro";
import Button from "../../../components/Button.astro";

interface Props {
  openExpr?: string;
  resultExpr?: string;
  onCloseExpr?: string;
}

const {
  openExpr = 'modalOpen',
  resultExpr = 'selected',
  onCloseExpr = 'modalOpen = false; selected = null',
} = Astro.props as Props;

const openCondition = `(${openExpr}) && (${resultExpr})`;
const responsesExpr = `${resultExpr}?.responses ?? []`;
console.log('responsesExpr', responsesExpr)
const scoreExpr = `${resultExpr}?.mark ?? 0`;
const totalExpr = `${resultExpr}?.totalQuestions ?? 0`;
const attemptExpr = `${resultExpr}?.id`;
const createdExpr = `${resultExpr}?.createdAtLabel`;
const questionLoop = `(question, index) in ${responsesExpr}`;
const optionsLoop = `(option, optionIndex) in question.options ?? []`;
const selectionCheck = `Number(question.selectedIndex ?? -1) === optionIndex && Number(question.selectedIndex ?? -1) >= 0`;
const assumedLabel = `question.selectionFallback ? 'Assumed answer' : 'Your answer'`;
const showExplanation = `question.explanation`;
const showSelectionMissing = `Number(question.selectedIndex ?? -1) < 0`;
const scoreLabelExpr = `(${scoreExpr}) + ' / ' + (${totalExpr})`;
---
<template x-if={openCondition}>
  <Modal
    size="lg"
    title="Answers"
    x-on:modal-close={onCloseExpr}
    x-on:keydown.escape.window={onCloseExpr}
  >
    <div class="space-y-5 text-sm text-slate-700">
      <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs font-semibold text-slate-500">
        <span>
          Attempt <span class="text-slate-900" x-text={attemptExpr}></span>
          Â· Taken on <span class="text-slate-900" x-text={createdExpr}></span>
        </span>
        <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 px-3 py-1 text-emerald-600">
          <i class="fas fa-star text-[10px]"></i>
          <span x-text={scoreLabelExpr}></span>
        </span>
      </div>
      <div class="max-h-[60vh] space-y-5 overflow-y-auto pr-1">
        <template x-if={`(${resultExpr}?.responses?.length ?? 0) === 0`}>
          <p class="rounded-2xl border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-slate-500">
            No answer details available for this attempt.
          </p>
        </template>
        <template x-for={questionLoop}>
          <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
            <header class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                  Question <span x-text="index + 1"></span>
                </p>
                <h4 class="mt-1 font-semibold text-slate-900" x-text="question.questionText"></h4>
              </div>
            </header>
            <ul class="mt-3 space-y-2">
              <template x-for={optionsLoop}>
                <li
                  class="rounded-xl border px-3 py-2"
                  :class="[
                    optionIndex === Number(question.correctIndex ?? -1)
                      ? 'border-emerald-300 bg-emerald-50 text-emerald-700'
                      : '',
                    optionIndex === Number(question.selectedIndex ?? -1) && optionIndex !== Number(question.correctIndex ?? -1)
                      ? 'border-rose-300 bg-rose-50 text-rose-700'
                      : '',
                    optionIndex !== Number(question.correctIndex ?? -1) && optionIndex !== Number(question.selectedIndex ?? -1)
                      ? 'border-slate-200 bg-white text-slate-700'
                      : ''
                  ].filter(Boolean).join(' ')"
                >
                  <div class="flex items-center justify-between gap-3 text-sm">
                    <span class="flex-1" x-text="option"></span>
                    <span
                      class="inline-flex items-center gap-1 rounded-full bg-slate-900/10 px-2 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-700"
                      x-show={selectionCheck}
                      x-cloak
                    >
                      <i class="fas fa-user-check text-[10px]"></i>
                      <span x-text={assumedLabel}></span>
                    </span>
                  </div>
                </li>
              </template>
            </ul>
            <p
              class="mt-3 rounded-xl bg-slate-100 px-3 py-2 text-xs text-slate-600"
              x-show={showExplanation}
              x-cloak
            >
              <span class="font-semibold text-slate-700">Explanation:</span>
              <span x-text="question.explanation"></span>
            </p>
            <p
              class="mt-2 text-xs font-medium text-amber-600"
              x-show={showSelectionMissing}
              x-cloak
            >
              We didn't capture your choice for this question in this attempt.
            </p>
          </article>
        </template>
      </div>
    </div>
    <div class="flex w-full items-center justify-end gap-3" slot="footer">
      <Button variant="outline" size="sm" x-on:click={onCloseExpr}>
        Close
      </Button>
    </div>
  </Modal>
</template>
