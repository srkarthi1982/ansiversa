---
import Layout from '../../../layouts/Layout.astro';
import { loadCoverLetterForShareToken } from '../../../actions/cover-letter/utils';
import { buildCoverLetterRenderModel } from '../../../lib/coverLetter/render/helpers';

const token = Astro.params.token ?? '';
const letter = token ? await loadCoverLetterForShareToken(token) : null;
const model = letter ? buildCoverLetterRenderModel(letter) : null;
const hasRtlCharacters = (value: string | null | undefined) => /[\u0590-\u08FF]/.test(value ?? '');
const direction =
  letter &&
  (hasRtlCharacters(letter.body) ||
    hasRtlCharacters(letter.prompts?.introduction) ||
    hasRtlCharacters(letter.prompts?.motivation) ||
    hasRtlCharacters(letter.prompts?.closing))
    ? 'rtl'
    : 'ltr';
---
<Layout>
  <main class="bg-slate-50 min-h-screen py-16" dir={direction}>
    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
      {model ? (
        <article class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
          <header class="space-y-2 text-center">
            <p class="text-xs uppercase tracking-wide text-slate-500">Shared cover letter</p>
            <h1 class="text-3xl font-semibold text-slate-900">{model.title}</h1>
            <p class="text-sm text-slate-500">Accessible for 7 days from the time of sharing.</p>
          </header>
          <div class="mt-8 space-y-5 text-sm leading-7 text-slate-700">
            <p>{model.recipientLine}</p>
            {model.paragraphs.map((paragraph) => <p>{paragraph}</p>)}
            <p>{model.closing}</p>
            {model.signature.split('\n').map((line) => <p>{line}</p>)}
          </div>
        </article>
      ) : (
        <div class="rounded-3xl border border-slate-200 bg-white p-10 text-center text-slate-600 shadow-sm">
          <i class="fas fa-link-slash text-4xl text-rose-400"></i>
          <h1 class="mt-6 text-2xl font-semibold text-slate-900">Link unavailable</h1>
          <p class="mt-3 text-sm">
            This shared link has expired or is no longer valid. Ask the owner to generate a new share link.
          </p>
        </div>
      )}
    </div>
  </main>
</Layout>
