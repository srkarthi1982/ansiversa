---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/Button.astro";
import SectionHeading from "../../components/SectionHeading.astro";
---
<Layout>
  <a class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:rounded-md focus:bg-white focus:px-4 focus:py-2 focus:text-sm focus:font-semibold focus:text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500" href="#job-analyzer-history">
    Skip to content
  </a>
  <main
    id="job-analyzer-history"
    class="min-h-screen bg-slate-50"
    x-data="() => ({ jobAnalyzer: $store.jobAnalyzer, filters: $store.jobAnalyzer.state.historyFilters })"
    x-init="jobAnalyzer.initHistory()"
  >
    <section class="relative overflow-hidden py-16 sm:py-20">
      <div class="absolute inset-0 bg-gradient-to-br from-indigo-100 via-white to-transparent"></div>
      <div class="relative mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
          <div class="space-y-4">
            <span class="inline-flex items-center gap-2 rounded-full bg-indigo-100 px-4 py-1.5 text-sm font-semibold text-indigo-700">
              <i class="fas fa-folder-tree text-xs"></i>
              Saved match reports
            </span>
            <h1 class="text-4xl font-bold tracking-tight text-slate-900 sm:text-5xl">History & saved reports</h1>
            <p class="max-w-2xl text-base text-slate-600 sm:text-lg">
              Revisit past analyses, publish read-only links, duplicate reports, and keep track of which JDs you have already tailored for. Pro users unlock unlimited saves and analytics.
            </p>
            <div class="flex flex-wrap gap-3">
              <Button href="/job-analyzer/upload">
                <i class="fas fa-plus text-xs"></i>
                New analysis
              </Button>
              <Button href="/job-analyzer/templates" variant="outline">
                <i class="fas fa-layer-group text-xs"></i>
                Templates
              </Button>
            </div>
          </div>
          <aside class="w-full max-w-sm rounded-3xl border border-indigo-100 bg-white/80 p-6 shadow-lg backdrop-blur">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Snapshot</h2>
            <dl class="mt-4 space-y-3 text-sm text-slate-600">
              <div class="flex items-center justify-between">
                <dt>Total reports</dt>
                <dd class="text-lg font-semibold text-slate-900" x-text="jobAnalyzer.state.historyStats.saved"></dd>
              </div>
              <div class="flex items-center justify-between">
                <dt>Published</dt>
                <dd class="text-lg font-semibold text-indigo-700" x-text="jobAnalyzer.state.historyStats.published"></dd>
              </div>
              <div class="flex items-center justify-between">
                <dt>Plan</dt>
                <dd class="text-sm font-semibold text-slate-900" x-text="jobAnalyzer.state.plan === 'pro' ? 'Pro' : 'Free'"></dd>
              </div>
            </dl>
            <p class="mt-4 text-xs text-slate-500">
              Free plan saves 1 report at a time with a watermark. Pro unlocks unlimited history, A/B testing, and watermark-free exports.
            </p>
          </aside>
        </div>
      </div>
    </section>

    <section class="pb-20">
      <div class="mx-auto max-w-6xl space-y-10 px-4 sm:px-6 lg:px-8">
        <SectionHeading
          eyebrow="Filters"
          title="Find a past analysis"
          description="Filter by plan requirement, score band, or search for company, role, or tagged skills."
        />
        <div class="flex flex-wrap items-center gap-3 rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
          <label class="flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600">
            <span class="sr-only">Plan filter</span>
            <i class="fas fa-crown text-xs"></i>
            <select
              class="appearance-none bg-transparent text-sm font-medium text-slate-700 focus:outline-none"
              x-model="filters.plan"
              @change="jobAnalyzer.setHistoryFilter('plan', filters.plan)"
            >
              <option value="all">All plans</option>
              <option value="free">Free</option>
              <option value="pro">Pro</option>
            </select>
          </label>
          <label class="flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600">
            <span class="sr-only">Score filter</span>
            <i class="fas fa-chart-simple text-xs"></i>
            <select
              class="appearance-none bg-transparent text-sm font-medium text-slate-700 focus:outline-none"
              x-model="filters.score"
              @change="jobAnalyzer.setHistoryFilter('score', filters.score)"
            >
              <option value="all">All scores</option>
              <option value="strong">75+ Strong fit</option>
              <option value="moderate">60â€“74 Moderate fit</option>
              <option value="developing">Under 60 Developing</option>
            </select>
          </label>
          <label class="flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-2 text-sm text-slate-600">
            <span class="sr-only">Search</span>
            <i class="fas fa-magnifying-glass text-xs"></i>
            <input
              type="search"
              class="w-48 bg-transparent text-sm font-medium text-slate-700 focus:outline-none"
              placeholder="Search role or company"
              x-model="filters.search"
              @input.debounce.400ms="jobAnalyzer.setHistorySearch(filters.search)"
            />
          </label>
        </div>

        <template x-if="jobAnalyzer.state.historyFiltered.length === 0">
          <div class="rounded-3xl border border-dashed border-slate-200 bg-white p-12 text-center">
            <i class="fas fa-clipboard-question text-3xl text-slate-300"></i>
            <h3 class="mt-4 text-lg font-semibold text-slate-900">No saved reports yet</h3>
            <p class="mt-2 text-sm text-slate-600">Run an analysis to save your first report and it will appear here.</p>
            <Button href="/job-analyzer/upload" class="mt-4">
              <i class="fas fa-gauge-high text-xs"></i>
              Run analyzer
            </Button>
          </div>
        </template>

        <div class="grid gap-6 lg:grid-cols-2">
          <template x-for="record in jobAnalyzer.state.historyFiltered" :key="record.id">
            <article
              class="flex h-full flex-col justify-between rounded-3xl border p-6 shadow-sm transition hover:-translate-y-1 hover:shadow-md"
              :class="record.planRequired === 'pro' ? 'border-amber-200 bg-amber-50/60' : 'border-slate-200 bg-white'"
            >
              <div class="space-y-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <h3 class="text-xl font-semibold text-slate-900" x-text="record.title"></h3>
                    <p class="text-sm text-slate-600" x-text="record.company"></p>
                  </div>
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold" :class="record.planRequired === 'pro' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'">
                    <i class="fas fa-crown text-[10px]"></i>
                    <span x-text="record.planRequired === 'pro' ? 'Pro' : 'Free'"></span>
                  </span>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500">
                  <span>
                    <i class="fas fa-calendar-day mr-1 text-[10px]"></i>
                    <span x-text="new Date(record.createdAt).toLocaleString()"></span>
                  </span>
                  <span>
                    <i class="fas fa-file-signature mr-1 text-[10px]"></i>
                    <span x-text="record.resumeTitle"></span>
                  </span>
                  <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600">
                    <i class="fas fa-chart-gauge text-[10px]"></i>
                    <span x-text="`${record.score}%`"></span>
                  </span>
                </div>
                <div class="flex flex-wrap gap-2">
                  <template x-for="tag in record.tags" :key="tag">
                    <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600" x-text="tag"></span>
                  </template>
                </div>
                <template x-if="record.planRequired === 'pro' && jobAnalyzer.state.plan !== 'pro'">
                  <div class="rounded-2xl border border-amber-200 bg-white/60 px-4 py-3 text-xs text-amber-700">
                    Upgrade to unlock this report, watermark-free exports, and analytics.
                  </div>
                </template>
              </div>
              <div class="mt-6 flex flex-wrap items-center gap-3">
                <template x-if="record.planRequired === 'pro' && jobAnalyzer.state.plan !== 'pro'">
                  <Button href="/app/pricing" variant="outline">
                    <i class="fas fa-eye text-xs"></i>
                    See plans
                  </Button>
                </template>
                <template x-if="!(record.planRequired === 'pro' && jobAnalyzer.state.plan !== 'pro')">
                  <Button variant="primary" :href="`/job-analyzer/result/${record.id}`">
                    <i class="fas fa-eye text-xs"></i>
                    Open report
                  </Button>
                </template>
                <Button type="button" variant="ghost" @click.prevent="jobAnalyzer.setActiveReport(record.id); jobAnalyzer.publishActiveReport()">
                  <i class="fas fa-share-nodes text-xs"></i>
                  Quick publish
                </Button>
              </div>
            </article>
          </template>
        </div>

        <div class="rounded-3xl border border-indigo-100 bg-indigo-50/70 p-6 text-sm text-indigo-700">
          <strong>Pro tip:</strong> Duplicate reports to test variations. Saved JSON exports can feed ATS trackers or recruiting dashboards.
        </div>
      </div>
    </section>
  </main>
</Layout>
