---
import SectionHeading from "../SectionHeading.astro";
import Button from "../Button.astro";
---
<section
  id="poem-workspace"
  class="border-t border-white/10 bg-slate-950 py-20 text-white"
  x-data="{ poem: $store['poem-studio'] }"
>
  <div class="mx-auto max-w-6xl space-y-12 px-4 sm:px-6 lg:px-8">
    <SectionHeading
      eyebrow="Craft workspace"
      title="Edit, analyse, and sequence poems without leaving the studio"
      description="Split-pane drafting keeps the poem in view while a craft panel tracks meter, rhyme, imagery, tone, and revision passes."
    />

    <div class="grid gap-8 lg:grid-cols-[1.2fr_0.8fr]">
      <div class="space-y-6 rounded-3xl border border-white/10 bg-white/5 p-6">
        <header class="flex flex-wrap items-start justify-between gap-4 border-b border-white/10 pb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-white/60">Active poem</p>
            <h2 class="mt-2 text-2xl font-semibold" x-text="poem.selectedPoem?.title ?? 'Select a poem'"></h2>
            <p class="mt-1 text-sm text-white/60">
              <span x-text="poem.selectedPoem?.form ?? '—'"></span>
              ·
              <span x-text="poem.selectedPoem?.tone ?? '—'"></span>
              ·
              <span x-text="poem.selectedPoem?.status ?? '—'"></span>
            </p>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-xs text-white/60">
            <span class="rounded-full bg-white/10 px-3 py-1" x-text="poem.selectedDraft ? `Last analysis ${poem.formatRelative(poem.selectedDraft.lastAnalysisAt)}` : 'No analysis yet'"></span>
            <span class="rounded-full bg-white/10 px-3 py-1" x-text="poem.selectedDraft?.readingTime ?? ''"></span>
            <Button type="button" variant="ghost" class="text-xs text-white/70 hover:text-white" @click="poem.refreshAnalysis()">
              <i class="fa-solid fa-rotate"></i>
              Refresh analysis
            </Button>
          </div>
        </header>

        <nav class="flex flex-wrap gap-3 text-sm font-semibold">
          <button
            type="button"
            class="rounded-full px-4 py-1.5 transition"
            :class="poem.view.activeWorkspaceTab === 'compose'
              ? 'bg-violet-500/30 text-white'
              : 'bg-white/5 text-white/60 hover:text-white'"
            @click="poem.setWorkspaceTab('compose')"
          >
            Compose
          </button>
          <button
            type="button"
            class="rounded-full px-4 py-1.5 transition"
            :class="poem.view.activeWorkspaceTab === 'analysis'
              ? 'bg-violet-500/30 text-white'
              : 'bg-white/5 text-white/60 hover:text-white'"
            @click="poem.setWorkspaceTab('analysis')"
          >
            Analysis
          </button>
          <button
            type="button"
            class="rounded-full px-4 py-1.5 transition"
            :class="poem.view.activeWorkspaceTab === 'revision'
              ? 'bg-violet-500/30 text-white'
              : 'bg-white/5 text-white/60 hover:text-white'"
            @click="poem.setWorkspaceTab('revision')"
          >
            Revision tools
          </button>
        </nav>

        <div class="rounded-3xl border border-white/10 bg-slate-950/50 p-5">
          <div x-cloak x-show="poem.view.activeWorkspaceTab === 'compose'" class="space-y-4">
            <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Draft lines</h3>
            <ul class="space-y-2 text-sm">
              <template x-for="line in poem.selectedDraft?.lines ?? []" :key="line.number">
                <li
                  class="rounded-2xl border px-3 py-2"
                  :class="[
                    line.emphasis === 'imagery'
                      ? 'border-emerald-400/50 bg-emerald-500/10'
                      : line.emphasis === 'meter'
                        ? 'border-sky-400/40 bg-sky-500/10'
                        : line.emphasis === 'performance'
                          ? 'border-amber-400/40 bg-amber-500/10'
                          : 'border-white/10 bg-white/5',
                  ]"
                >
                  <div class="flex items-start justify-between gap-3">
                    <p class="font-mono text-sm" x-text="line.text"></p>
                    <span class="text-xs text-white/50" x-text="`L${line.number}`"></span>
                  </div>
                  <template x-if="line.suggestion">
                    <p class="mt-2 text-xs text-white/60">
                      <i class="fa-solid fa-lightbulb text-[10px]"></i>
                      <span x-text="line.suggestion"></span>
                    </p>
                  </template>
                </li>
              </template>
            </ul>
            <template x-if="!(poem.selectedDraft?.lines?.length)">
              <p class="text-sm text-white/60">Select a poem from the library to view its draft.</p>
            </template>
          </div>

          <div x-cloak x-show="poem.view.activeWorkspaceTab === 'analysis'" class="space-y-4">
            <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Insights</h3>
            <ul class="space-y-3 text-sm">
              <template x-for="insight in poem.selectedAnalysis?.insights ?? []" :key="insight.id">
                <li
                  class="rounded-2xl border px-4 py-3 transition"
                  :class="[
                    insight.severity === 'critical'
                      ? 'border-rose-500/60 bg-rose-500/10'
                      : insight.severity === 'warning'
                        ? 'border-amber-400/60 bg-amber-500/10'
                        : 'border-white/10 bg-white/5',
                    poem.view.highlightedInsightId === insight.id ? 'ring-2 ring-violet-400' : '',
                  ]"
                  @mouseenter="poem.setHighlightedInsight(insight.id)"
                  @mouseleave="poem.setHighlightedInsight(null)"
                >
                  <p class="text-xs uppercase tracking-[0.3em] text-white/50" x-text="insight.label"></p>
                  <p class="mt-2 text-sm font-semibold" x-text="insight.value"></p>
                  <p class="mt-1 text-xs text-white/70" x-text="insight.detail"></p>
                </li>
              </template>
            </ul>
            <template x-if="!(poem.selectedAnalysis?.insights?.length)">
              <p class="text-sm text-white/60">Run analysis to see imagery, meter, and diction guidance.</p>
            </template>
          </div>

          <div x-cloak x-show="poem.view.activeWorkspaceTab === 'revision'" class="space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Revision passes</h3>
              <span class="text-xs text-white/50">AI passes completed: <span x-text="poem.state.aiUsage.passes"></span></span>
            </div>
            <div class="grid gap-3 sm:grid-cols-2">
              <template x-for="pass in poem.passes" :key="pass.key">
                <button
                  type="button"
                  class="rounded-2xl border px-4 py-3 text-left transition"
                  :class="[
                    poem.view.activePassKey === pass.key
                      ? 'border-violet-400/60 bg-violet-500/20 text-white'
                      : 'border-white/10 bg-white/5 text-white/70 hover:border-white/30 hover:text-white',
                    poem.isPassLocked(pass.key) ? 'opacity-60' : '',
                  ]"
                  @click="poem.setActivePass(pass.key)"
                >
                  <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-white/50">
                    <span x-text="pass.label"></span>
                    <span x-text="pass.gating === 'pro' ? 'PRO' : 'FREE'"></span>
                  </div>
                  <p class="mt-2 text-sm text-white/80" x-text="pass.description"></p>
                  <p class="mt-2 text-xs text-white/60" x-text="`Focus: ${pass.focus}`"></p>
                </button>
              </template>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-white/80">
              <p class="font-semibold" x-text="poem.activePass?.label ?? 'Select a pass'"></p>
              <p class="mt-2 text-sm text-white/70" x-text="poem.activePass?.prompt ?? 'Choose a revision pass to see guidance.'"></p>
              <Button
                type="button"
                class="mt-4 bg-white text-slate-950 hover:bg-slate-100"
                :class="poem.isPassLocked(poem.view.activePassKey) ? 'pointer-events-none opacity-60' : ''"
                @click="poem.runPass(poem.view.activePassKey)"
              >
                <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
                Run selected pass
              </Button>
              <template x-if="poem.isPassLocked(poem.view.activePassKey)">
                <p class="mt-3 text-xs text-white/60">Upgrade to Pro to unlock this craft pass.</p>
              </template>
            </div>
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-white/50">Form constraints</p>
            <ul class="mt-3 space-y-2 text-sm text-white/70">
              <template x-for="constraint in poem.selectedForm?.constraints ?? []" :key="constraint.label">
                <li class="flex items-start gap-2">
                  <span class="mt-1 size-2 rounded-full bg-violet-300"></span>
                  <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-white/50" x-text="constraint.label"></p>
                    <p class="text-sm" x-text="constraint.detail"></p>
                  </div>
                </li>
              </template>
              <template x-if="!(poem.selectedForm?.constraints?.length)">
                <li class="text-sm text-white/60">Choose a poem to review its form guardrails.</li>
              </template>
            </ul>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-white/50">Analysis highlights</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <template x-for="chip in poem.analysisChips" :key="chip.key">
                <span
                  class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold"
                  :class="chip.tone === 'good'
                    ? 'bg-emerald-500/20 text-emerald-100'
                    : chip.tone === 'ok'
                      ? 'bg-sky-500/20 text-sky-100'
                      : 'bg-amber-500/20 text-amber-100'"
                >
                  <i class="fa-solid" :class="chip.key === 'meter' ? 'fa-wave-square' : chip.key === 'rhyme' ? 'fa-diamond' : chip.key === 'imagery' ? 'fa-camera-retro' : 'fa-italic'"></i>
                  <span x-text="`${chip.label}: ${chip.value}`"></span>
                </span>
              </template>
              <template x-if="!poem.analysisChips.length">
                <span class="text-xs text-white/60">Run an analysis to surface key metrics.</span>
              </template>
            </div>
          </div>
        </div>
      </div>

      <aside class="space-y-6 rounded-3xl border border-white/10 bg-white/5 p-6">
        <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Flagged lines</h3>
          <ul class="mt-3 space-y-3 text-sm">
            <template x-for="flag in poem.selectedAnalysis?.flaggedLines ?? []" :key="flag.line">
              <li class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2">
                <p class="text-xs uppercase tracking-[0.3em] text-white/50" x-text="`Line ${flag.line}`"></p>
                <p class="mt-1 text-sm font-semibold" x-text="flag.issue"></p>
                <p class="mt-1 text-xs text-white/60" x-text="flag.fix"></p>
              </li>
            </template>
            <template x-if="!(poem.selectedAnalysis?.flaggedLines?.length)">
              <li class="text-sm text-white/60">No issues flagged in the latest scan.</li>
            </template>
          </ul>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Near rhymes and imagery mix</h3>
          <template x-if="poem.advancedAnalysisLocked">
            <p class="mt-3 text-xs text-white/60">Upgrade to Pro to unlock near-rhyme suggestions and imagery breakdown charts.</p>
          </template>
          <template x-if="!poem.advancedAnalysisLocked">
            <div class="mt-3 space-y-3 text-sm">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-white/50">Near rhymes</p>
                <ul class="mt-2 space-y-2">
                  <template x-for="entry in poem.selectedAnalysis?.nearRhymes ?? []" :key="entry.word">
                    <li class="flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm">
                      <span class="text-white/80" x-text="entry.word"></span>
                      <span class="text-xs text-white/60" x-text="entry.suggestion"></span>
                    </li>
                  </template>
                  <template x-if="!(poem.selectedAnalysis?.nearRhymes?.length)">
                    <li class="text-xs text-white/60">No rhyme adjustments suggested.</li>
                  </template>
                </ul>
              </div>
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-white/50">Imagery palette</p>
                <div class="mt-2 space-y-2">
                  <template x-for="slice in poem.selectedAnalysis?.imageryBreakdown ?? []" :key="slice.label">
                    <div class="space-y-1">
                      <div class="flex items-center justify-between text-xs text-white/60">
                        <span x-text="slice.label"></span>
                        <span x-text="`${slice.percent}%`"></span>
                      </div>
                      <div class="h-1.5 rounded-full bg-white/10">
                        <div class="h-full rounded-full bg-gradient-to-r from-violet-400 via-fuchsia-400 to-sky-400" :style="`width: ${slice.percent}%`"></div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4">
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Prompt seeds</h3>
          <ul class="mt-3 space-y-2 text-sm">
            <template x-for="seed in poem.promptSeeds" :key="seed.id">
              <li class="flex items-start justify-between gap-3 rounded-2xl border border-white/10 bg-white/5 px-3 py-2">
                <div>
                  <p class="text-sm font-semibold text-white" x-text="seed.label"></p>
                  <p class="text-xs text-white/60" x-text="seed.description"></p>
                </div>
                <Button type="button" class="bg-white/90 text-slate-900 hover:bg-white" @click="poem.generatePrompt(seed.id)">
                  <i class="fa-solid fa-sparkles text-xs"></i>
                  Expand
                </Button>
              </li>
            </template>
          </ul>
        </div>
      </aside>
    </div>

    <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
      <div class="space-y-6 rounded-3xl border border-white/10 bg-white/5 p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Chapbook builder</h3>
          <span class="text-xs text-white/60" x-text="poem.isChapbookLocked ? 'Pro feature' : 'Included with plan'"></span>
        </div>
        <template x-if="poem.isChapbookLocked">
          <p class="text-sm text-white/60">
            Upgrade to Pro to unlock collection sequencing, section dividers, and chapbook exports.
          </p>
        </template>
        <template x-if="!poem.isChapbookLocked">
          <div class="space-y-5">
            <div class="flex flex-wrap gap-2">
              <template x-for="collection in poem.state.collections" :key="collection.id">
                <button
                  type="button"
                  class="rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.3em] transition"
                  :class="poem.view.selectedCollectionId === collection.id
                    ? 'border-violet-400 bg-violet-500/20 text-white'
                    : 'border-white/20 text-white/60 hover:border-white/40 hover:text-white'"
                  @click="poem.selectCollection(collection.id)"
                  x-text="collection.title"
                ></button>
              </template>
            </div>
            <div class="rounded-3xl border border-white/10 bg-slate-950/60 p-5">
              <p class="text-xs uppercase tracking-[0.3em] text-white/50">Collection focus</p>
              <p class="mt-2 text-sm text-white/80" x-text="poem.selectedCollection?.focus ?? 'Select a collection to view details.'"></p>
              <p class="mt-3 text-xs text-white/50">
                Progress: <span x-text="poem.selectedCollection ? Math.round((poem.selectedCollection.progress ?? 0) * 100) : 0"></span>%
              </p>
              <ul class="mt-4 space-y-2 text-sm">
                <template x-for="poemItem in poem.selectedCollectionPoems" :key="poemItem.id">
                  <li class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2">
                    <p class="font-semibold" x-text="poemItem.title"></p>
                    <p class="text-xs text-white/60" x-text="`${poemItem.lines} lines · ${poemItem.analysisSummary.voice}`"></p>
                  </li>
                </template>
              </ul>
            </div>
          </div>
        </template>
      </div>
      <div class="space-y-6 rounded-3xl border border-white/10 bg-white/5 p-6">
        <div>
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Exports</h3>
          <ul class="mt-3 space-y-3 text-sm">
            <template x-for="preset in poem.exportPresets" :key="preset.id">
              <li class="rounded-2xl border border-white/10 bg-slate-950/50 px-4 py-3">
                <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-white/50">
                  <span x-text="preset.label"></span>
                  <span x-text="preset.plan === 'pro' ? 'PRO' : 'FREE'"></span>
                </div>
                <p class="mt-2 text-white/80" x-text="preset.description"></p>
                <p class="mt-1 text-xs text-white/60" x-text="`Includes: ${preset.includes.join(', ')}`"></p>
                <Button
                  type="button"
                  class="mt-3 bg-white text-slate-950 hover:bg-slate-100"
                  :class="poem.isExportLocked(preset.id) ? 'pointer-events-none opacity-60' : ''"
                  @click="poem.queueExport(preset.id)"
                >
                  <i class="fa-solid fa-file-export text-xs"></i>
                  Queue export
                </Button>
                <template x-if="poem.isExportLocked(preset.id)">
                  <p class="mt-2 text-xs text-white/60">Pro upgrade unlocks PDF and DOCX layouts.</p>
                </template>
              </li>
            </template>
          </ul>
        </div>
        <div>
          <h3 class="text-sm font-semibold uppercase tracking-[0.3em] text-white/60">Integrations</h3>
          <div class="mt-3 grid gap-3 sm:grid-cols-2">
            <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4 text-sm text-white/70">
              <p class="font-semibold text-white">StoryCrafter</p>
              <p class="mt-1 text-xs text-white/60">Drop lyrical interludes or poem-based flashbacks into scenes.</p>
            </div>
            <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4 text-sm text-white/70">
              <p class="font-semibold text-white">Presentation Designer</p>
              <p class="mt-1 text-xs text-white/60">Send poetry slides with performance pacing baked in.</p>
            </div>
            <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4 text-sm text-white/70">
              <p class="font-semibold text-white">Research Assistant</p>
              <p class="mt-1 text-xs text-white/60">Surface quick context facts or references without breaking flow.</p>
            </div>
            <div class="rounded-2xl border border-white/10 bg-slate-950/50 p-4 text-sm text-white/70">
              <p class="font-semibold text-white">Grammar Fixer</p>
              <p class="mt-1 text-xs text-white/60">Run gentle copyedits after the craft passes are complete.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
